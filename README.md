# Fish Tank VR Test (Quad Reprojection)

Head-Coupled Perspective / Fish-Tank VR прототип с использованием техники **Quad Reprojection / Generalized Off-Axis Projection**.

Прототип "head-coupled perspective" эффекта с использованием техники **Quad Reprojection / Generalized Off-Axis Projection**, как в TouchDesigner. Экран монитора является физическим QUAD в 3D пространстве, создавая эффект "окна/портала" в 3D.

## Технологии

- **Vite** + **React** + **TypeScript**
- **Three.js** для 3D рендеринга
- **MediaPipe Face Mesh** для трекинга лица (опционально)
- **Quad Reprojection** математика для правильной проекции

## Установка

```bash
npm install
```

## Запуск

```bash
npm run dev
```

Откройте браузер по адресу, который покажет Vite (обычно `http://localhost:5173`).

## Калибровка

Для правильной работы эффекта необходимо откалибровать физические параметры вашего экрана:

1. **screenWidthCm** - ширина экрана в сантиметрах (по умолчанию 60)
2. **screenHeightCm** - высота экрана в сантиметрах (по умолчанию 34)
3. **viewerDistanceCm** - расстояние от экрана до ваших глаз в сантиметрах (по умолчанию 65)

### Как выставить калибровку:

1. Измерьте физические размеры вашего монитора (ширину и высоту в см)
2. Введите эти значения в соответствующие поля в UI (слева вверху)
3. Оцените расстояние от экрана до ваших глаз и введите в "viewerDistanceCm"
4. Нажмите "Recenter" чтобы установить текущую позицию как центр (нулевое смещение)

### Проверка работы эффекта:

1. **Mouse Demo Mode** (по умолчанию включен):
   - Двигайте мышью по экрану - перспектива должна "заглядывать" внутрь коробки как в окно
   - При движении мыши влево - видно больше правой стороны коробки
   - При движении мыши вправо - видно больше левой стороны коробки
   - Эффект должен выглядеть как "портал", а не просто вращение камеры

2. **Face Tracking** (опционально):
   - Нажмите "Enable Mouse Demo" чтобы выключить mouse mode
   - Разрешите доступ к веб-камере при запросе браузера
   - Сядьте перед камерой на комфортном расстоянии (около 60-70 см)
   - Нажмите "Recenter" чтобы зафиксировать центральную позицию
   - Медленно двигайте головой влево/вправо - перспектива должна "заглядывать" внутрь коробки

## Настройки

- **Smoothing Alpha** - параметр сглаживания (0-1). Чем меньше значение, тем более плавное движение, но больше задержка. По умолчанию 0.04.
- **Recenter** - сбросить текущую позицию как центр (нулевое смещение X/Y)

## Архитектура

```
src/
├── App.tsx              # Главный компонент, управление состоянием
├── three/
│   └── scene.ts         # Создание Three.js сцены, wireframe коробки и сеток
├── math/
│   └── quadReprojection.ts  # Quad Reprojection математика
├── tracking/
│   └── face.ts          # MediaPipe инициализация и трекинг лица
└── utils/
    └── smoothing.ts     # EMA фильтры для сглаживания
```

## Принцип работы (Quad Reprojection)

1. **Экран как QUAD**: Экран описывается 3 углами (pa, pb, pc) в 3D пространстве
2. **Базис экрана**: Строятся векторы vr (right), vu (up), vn (normal) из углов экрана
3. **Frustum boundaries**: Границы frustum вычисляются через dot products с базисом экрана
4. **Projection matrix**: Строится из l/r/b/t границ frustum
5. **View matrix**: Строится из базиса экрана (vr, vu, vn) и позиции глаза, БЕЗ использования lookAt()
6. **Рендеринг**: Three.js рендерит wireframe сцену с обновленной проекцией

## Требования

- Современный браузер с поддержкой WebGL
- Веб-камера (опционально, mouse demo работает без камеры)
- HTTPS или localhost (MediaPipe требует безопасный контекст)

## Ключевые отличия от обычной камеры

- **НЕ используется FOV подбор** - проекция строится из физических размеров экрана
- **НЕ используется camera.lookAt()** - view matrix строится из базиса экрана
- **Экран = плоскость проекции** - экран является физическим QUAD в 3D, а не просто объектом в сцене

# Head-Tracked 3D Window

Прототип "Head-tracked 3D window" на основе техники off-axis projection, как в видео Johnny Chung Lee (Head Tracking for Desktop VR Displays).

## Технологии

- **Vite** + **TypeScript** - сборка проекта
- **Three.js** - 3D рендеринг
- **@mediapipe/tasks-vision** - трекинг головы через FaceLandmarker
- Чистый TypeScript без React для максимальной производительности

## Установка и запуск

```bash
npm install
npm run dev
```

Откройте `http://localhost:5173` в браузере (Chrome рекомендуется).

## Использование

1. **Включите камеру**: Нажмите кнопку "Enable Camera" в левом верхнем углу
2. **Разрешите доступ к камере**: Браузер запросит разрешение на использование веб-камеры
3. **Двигайте головой**: Перспектива сцены будет меняться в реальном времени
4. **Калибровка**: Используйте слайдеры для настройки размеров экрана и расстояния

## Управление

### Кнопки и слайдеры

- **Enable Camera** / **Disable Camera** - включить/выключить трекинг
- **Show Debug** / **Hide Debug** - показать/скрыть превью камеры с landmarks
- **Tracking Strength** (0-2) - сила реакции на движение головы
- **Smoothing** (0-0.95) - сглаживание движения (EMA alpha)
- **Screen Width/Height (cm)** - физические размеры экрана
- **Distance (cm)** - базовое расстояние до экрана
- **Reset Calibration** - сброс калибровки к значениям по умолчанию

### Горячие клавиши

- **D** - переключить debug overlay
- **M** - переключить mouse mode (имитация движения головы мышью)
- **R** - сброс калибровки

### Mouse Mode

Если камера недоступна или вы хотите протестировать без камеры:
1. Нажмите **M** для включения mouse mode
2. Двигайте мышью для изменения позиции X/Y
3. Используйте колесо мыши для изменения расстояния Z

## Калибровка

Для оптимального эффекта "окна в 3D" настройте параметры под ваш монитор:

1. **Screen Width/Height**: Измерьте физические размеры вашего экрана в сантиметрах
   - По умолчанию: 30.4cm × 19.7cm (MacBook 13")
   
2. **Distance**: Установите базовое расстояние от глаз до экрана
   - По умолчанию: 60cm
   - Можно настроить вручную или использовать "Recenter"

3. **Recenter**: Нажмите кнопку "Reset Calibration" или клавишу **R** для сброса смещения

## Архитектура

```
src/
├── main.ts                 # Точка входа, координация модулей
├── render/
│   ├── scene.ts           # Создание 3D сцены (мишени, wireframe)
│   └── offAxisCamera.ts   # Off-axis projection (Kooima approach)
├── tracking/
│   └── faceTracker.ts     # MediaPipe FaceLandmarker, обработка landmarks
├── ui/
│   └── hud.ts             # Минимальный UI overlay
└── styles.css             # Стили HUD
```

## Особенности реализации

### Off-Axis Projection

Реализована техника generalized perspective projection:
- Экран определяется как физический QUAD в 3D пространстве
- Проекционная матрица строится на основе позиции глаза относительно экрана
- View matrix формируется из базисных векторов экрана
- Обеспечивает эффект "окна в 3D" вместо простого вращения камеры

### Head Tracking

- Использует MediaPipe FaceLandmarker для детекции лица
- Оценка позиции X/Y из центра лица
- Оценка Z из межзрачкового расстояния (IPD)
- EMA сглаживание для стабильности
- Автоматический возврат к центру при потере лица

### Сцена

- 10 мишеней (concentric targets) на разных глубинах
- Wireframe box вокруг сцены
- Черный фон, белые линии
- Текстуры мишеней генерируются через Canvas2D

## Параметры по умолчанию

```typescript
screenWidthCm: 30.4
screenHeightCm: 19.7
viewerDistanceCm: 60
near: 0.1
far: 200
trackingStrength: 1.0
smoothing: 0.7
```

## Troubleshooting

**Камера не работает:**
- Убедитесь, что браузер имеет доступ к камере
- Используйте Mouse Mode (клавиша M) для тестирования без камеры

**Эффект не работает как ожидается:**
- Проверьте калибровку размеров экрана
- Настройте расстояние до экрана
- Попробуйте изменить Tracking Strength

**Низкий FPS:**
- Уменьшите разрешение камеры в настройках браузера
- Отключите debug overlay
- Уменьшите Smoothing для более быстрой реакции

## Лицензия

MIT
